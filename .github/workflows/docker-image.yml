#name: Build and Push
#on:
#  push:
#    branches: [ "main" ]
##    paths:
##      - "app/**"
#
#jobs:
#  build-and-push:
#    runs-on: ubuntu-latest
#    permissions:
#      contents: read
#      packages: write
#
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#        with:
#          submodules: recursive
#
#      - name: Derive image tag
#        id: settag
#        run: echo "image_tag=sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
#
#      - name: Derive lowercase owner
#        id: setowner
#        run: echo "owner_lc=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"
#
#      - name: Set up Docker
#        uses: docker/setup-buildx-action@v3
#
#      - name: Login to GitHub Container Registry
#        uses: docker/login-action@v3
#        with:
#          registry: ghcr.io
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: Build with docker-compose
#        run: |
#          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ñ‚ĞµĞ³Ğ¾Ğ²
#          export IMAGE_TAG=${{ steps.settag.outputs.image_tag }}
#          export REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}
#
#          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
#          docker compose build main-service study-service ml-service migrator
#
#          # ĞŸĞµÑ€ĞµÑ‚ÑĞ³Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹ Ğ´Ğ»Ñ registry Ñ Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑĞ¾Ğ¼ team6-
#          for service in main-service study-service ml-service migrator; do
#            docker tag team6-${service}:latest ${REGISTRY}/team6-${service}:${IMAGE_TAG}
#            docker tag team6-${service}:latest ${REGISTRY}/team6-${service}:latest
#          done
#
#      - name: Push images
#        run: |
#          export IMAGE_TAG=${{ steps.settag.outputs.image_tag }}
#          export REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}
#
#          # ĞŸÑƒÑˆĞ¸Ğ¼ Ğ²ÑĞµ Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹
#          for service in main-service study-service ml-service migrator; do
#            echo "Pushing team6-${service}..."
#            docker push ${REGISTRY}/team6-${service}:${IMAGE_TAG}
#            docker push ${REGISTRY}/team6-${service}:latest
#          done

name: Build and Push
on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Derive image tag
        id: settag
        run: echo "image_tag=sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Derive lowercase owner
        id: setowner
        run: echo "owner_lc=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build with docker-compose
        run: |
          export IMAGE_TAG=${{ steps.settag.outputs.image_tag }}
          export REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}
          
          echo "ğŸš€ Starting build process..."
          docker compose build main-service study-service ml-service migrator
          
          for service in main-service study-service ml-service migrator; do
            docker tag team6-${service}:latest ${REGISTRY}/team6-${service}:${IMAGE_TAG}
            docker tag team6-${service}:latest ${REGISTRY}/team6-${service}:latest
          done

      - name: Push images
        run: |
          export IMAGE_TAG=${{ steps.settag.outputs.image_tag }}
          export REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}
          
          echo "ğŸ“¤ Pushing images..."
          for service in main-service study-service ml-service migrator; do
            docker push ${REGISTRY}/team6-${service}:${IMAGE_TAG}
            docker push ${REGISTRY}/team6-${service}:latest
          done

      - name: Create Fancy Build Summary
        if: success()
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          # ğŸš€ Docker Build Summary
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                      BUILD SUCCESSFUL!                       â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ## ğŸ“‹ Build Details
          
          | ğŸ“ Parameter | ğŸ“ Value |
          |--------------|----------|
          | **Repository** | \`${{ github.repository }}\` |
          | **Commit** | [\`${GITHUB_SHA::8}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |
          | **Branch** | \`${{ github.ref_name }}\` |
          | **Built by** | @${{ github.actor }} |
          | **Timestamp** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |
          
          ## ğŸ³ Generated Docker Images
          
          | Service | Status | Image Tags |
          |---------|--------|------------|
          | ğŸ  **main-service** | âœ… | \`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-main-service:${{ steps.settag.outputs.image_tag }}\`<br>\`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-main-service:latest\` |
          | ğŸ“š **study-service** | âœ… | \`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-study-service:${{ steps.settag.outputs.image_tag }}\`<br>\`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-study-service:latest\` |
          | ğŸ¤– **ml-service** | âœ… | \`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-ml-service:${{ steps.settag.outputs.image_tag }}\`<br>\`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-ml-service:latest\` |
          | ğŸ—ƒï¸ **migrator** | âœ… | \`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-migrator:${{ steps.settag.outputs.image_tag }}\`<br>\`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-migrator:latest\` |
          
          ## ğŸ”— Quick Access
          
          ğŸ”— **[View all packages](https://github.com/${{ github.repository }}/packages)**
          
          ğŸ“‹ **Copy-paste commands:**
          
          \`\`\`bash
          # Login to GitHub Container Registry
          echo "\${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Pull latest images
          docker pull ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-main-service:latest
          docker pull ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-study-service:latest
          docker pull ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-ml-service:latest
          docker pull ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-migrator:latest
          \`\`\`
          
          ## ğŸ¯ Next Steps
          
          1. ğŸ§ª **Test** - Run integration tests with the new images
          2. ğŸš€ **Deploy** - Update your deployment configuration
          3. ğŸ“Š **Monitor** - Check application metrics after deployment
          
          ---
          
          *This summary was automatically generated by GitHub Actions*
          EOF