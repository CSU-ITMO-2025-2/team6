#name: Build and Push
#on:
#  push:
#    branches: [ "main" ]
##    paths:
##      - "app/**"
#
#jobs:
#  build-and-push:
#    runs-on: ubuntu-latest
#    permissions:
#      contents: read
#      packages: write
#
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#        with:
#          submodules: recursive
#
#      - name: Derive image tag
#        id: settag
#        run: echo "image_tag=sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
#
#      - name: Derive lowercase owner
#        id: setowner
#        run: echo "owner_lc=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"
#
#      - name: Set up Docker
#        uses: docker/setup-buildx-action@v3
#
#      - name: Login to GitHub Container Registry
#        uses: docker/login-action@v3
#        with:
#          registry: ghcr.io
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: Build with docker-compose
#        run: |
#          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ñ‚ÐµÐ³Ð¾Ð²
#          export IMAGE_TAG=${{ steps.settag.outputs.image_tag }}
#          export REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}
#
#          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
#          docker compose build main-service study-service ml-service migrator
#
#          # ÐŸÐµÑ€ÐµÑ‚ÑÐ³Ð¸Ð²Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð´Ð»Ñ registry Ñ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ¾Ð¼ team6-
#          for service in main-service study-service ml-service migrator; do
#            docker tag team6-${service}:latest ${REGISTRY}/team6-${service}:${IMAGE_TAG}
#            docker tag team6-${service}:latest ${REGISTRY}/team6-${service}:latest
#          done
#
#      - name: Push images
#        run: |
#          export IMAGE_TAG=${{ steps.settag.outputs.image_tag }}
#          export REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}
#
#          # ÐŸÑƒÑˆÐ¸Ð¼ Ð²ÑÐµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
#          for service in main-service study-service ml-service migrator; do
#            echo "Pushing team6-${service}..."
#            docker push ${REGISTRY}/team6-${service}:${IMAGE_TAG}
#            docker push ${REGISTRY}/team6-${service}:latest
#          done

name: Build and Push
on:
  push:
    branches: [ "main" ]
#    paths:
#      - "app/**"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Derive image tag
        id: settag
        run: echo "image_tag=sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Derive lowercase owner
        id: setowner
        run: echo "owner_lc=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build with docker-compose
        run: |
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ñ‚ÐµÐ³Ð¾Ð²
          export IMAGE_TAG=${{ steps.settag.outputs.image_tag }}
          export REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}
          
          echo "ðŸš€ Starting build process..."
          echo "ðŸ“¦ Image tag: ${IMAGE_TAG}"
          echo "ðŸ·ï¸  Registry: ${REGISTRY}"
          echo ""
          
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
          docker compose build main-service study-service ml-service migrator
          
          # ÐŸÐµÑ€ÐµÑ‚ÑÐ³Ð¸Ð²Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð´Ð»Ñ registry Ñ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ¾Ð¼ team6-
          for service in main-service study-service ml-service migrator; do
            echo "ðŸ”– Tagging team6-${service}..."
            docker tag team6-${service}:latest ${REGISTRY}/team6-${service}:${IMAGE_TAG}
            docker tag team6-${service}:latest ${REGISTRY}/team6-${service}:latest
          done
          
          echo "âœ… Build completed!"

      - name: Push images
        run: |
          export IMAGE_TAG=${{ steps.settag.outputs.image_tag }}
          export REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}
          
          echo "ðŸ“¤ Pushing images to GitHub Container Registry..."
          echo ""
          
          # ÐŸÑƒÑˆÐ¸Ð¼ Ð²ÑÐµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
          for service in main-service study-service ml-service migrator; do
            echo "â¬†ï¸  Pushing team6-${service}..."
            docker push ${REGISTRY}/team6-${service}:${IMAGE_TAG}
            docker push ${REGISTRY}/team6-${service}:latest
            echo "âœ… team6-${service} pushed successfully"
            echo ""
          done

      - name: Create deployment summary
        if: success()
        run: |
          echo "ðŸŽ‰ DEPLOYMENT SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“Š Build Information:"
          echo "   â€¢ Repository:    ${{ github.repository }}"
          echo "   â€¢ Commit:        ${{ github.sha }}"
          echo "   â€¢ Branch:        ${{ github.ref_name }}"
          echo "   â€¢ Triggered by:  ${{ github.actor }}"
          echo ""
          echo "ðŸ“¦ Built Images:"
          echo "   â€¢ main-service:   ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-main-service:${{ steps.settag.outputs.image_tag }}"
          echo "   â€¢ study-service:  ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-study-service:${{ steps.settag.outputs.image_tag }}"
          echo "   â€¢ ml-service:     ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-ml-service:${{ steps.settag.outputs.image_tag }}"
          echo "   â€¢ migrator:       ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-migrator:${{ steps.settag.outputs.image_tag }}"
          echo ""
          echo "ðŸ”— Quick Links:"
          echo "   â€¢ GitHub Packages: https://github.com/${{ github.repository }}/packages"
          echo "   â€¢ Commit Details:  ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          echo ""
          echo "ðŸš€ Next Steps:"
          echo "   1. Update deployment manifests with new image tags"
          echo "   2. Run automated tests with the new images"
          echo "   3. Deploy to staging environment"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð² Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² Ð´Ñ€ÑƒÐ³Ð¸Ñ… steps
          echo "IMAGE_TAG=${{ steps.settag.outputs.image_tag }}" >> $GITHUB_ENV
          echo "REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}" >> $GITHUB_ENV
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ markdown summary Ð´Ð»Ñ PR
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… Images built successfully:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Service | Image Tag |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-----------|" >> $GITHUB_STEP_SUMMARY
            echo "| main-service | \`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-main-service:${{ steps.settag.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| study-service | \`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-study-service:${{ steps.settag.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ml-service | \`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-ml-service:${{ steps.settag.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| migrator | \`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-migrator:${{ steps.settag.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Registry:** \`ghcr.io/${{ steps.setowner.outputs.owner_lc }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— [View all packages](https://github.com/${{ github.repository }}/packages)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload build artifacts (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-build-logs
          path: |
            /tmp/docker-build-*.log
          retention-days: 7
