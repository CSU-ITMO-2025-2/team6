#name: Build and Push
#on:
#  push:
#    branches: [ "main" ]
##    paths:
##      - "app/**"
#
#jobs:
#  build-and-push:
#    runs-on: ubuntu-latest
#    permissions:
#      contents: read
#      packages: write
#
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#        with:
#          submodules: recursive
#
#      - name: Derive image tag
#        id: settag
#        run: echo "image_tag=sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
#
#      - name: Derive lowercase owner
#        id: setowner
#        run: echo "owner_lc=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"
#
#      - name: Set up Docker
#        uses: docker/setup-buildx-action@v3
#
#      - name: Login to GitHub Container Registry
#        uses: docker/login-action@v3
#        with:
#          registry: ghcr.io
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#
#      - name: Build with docker-compose
#        run: |
#          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ñ‚ÐµÐ³Ð¾Ð²
#          export IMAGE_TAG=${{ steps.settag.outputs.image_tag }}
#          export REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}
#
#          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
#          docker compose build main-service study-service ml-service migrator
#
#          # ÐŸÐµÑ€ÐµÑ‚ÑÐ³Ð¸Ð²Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð´Ð»Ñ registry Ñ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ¾Ð¼ team6-
#          for service in main-service study-service ml-service migrator; do
#            docker tag team6-${service}:latest ${REGISTRY}/team6-${service}:${IMAGE_TAG}
#            docker tag team6-${service}:latest ${REGISTRY}/team6-${service}:latest
#          done
#
#      - name: Push images
#        run: |
#          export IMAGE_TAG=${{ steps.settag.outputs.image_tag }}
#          export REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}
#
#          # ÐŸÑƒÑˆÐ¸Ð¼ Ð²ÑÐµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
#          for service in main-service study-service ml-service migrator; do
#            echo "Pushing team6-${service}..."
#            docker push ${REGISTRY}/team6-${service}:${IMAGE_TAG}
#            docker push ${REGISTRY}/team6-${service}:latest
#          done

name: Build and Push
on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Derive image tag
        id: settag
        run: echo "image_tag=sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Derive lowercase owner
        id: setowner
        run: echo "owner_lc=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build with docker-compose
        run: |
          export IMAGE_TAG=${{ steps.settag.outputs.image_tag }}
          export REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}
          
          echo "ðŸš€ Starting build process..."
          docker compose build main-service study-service ml-service migrator
          
          for service in main-service study-service ml-service migrator; do
            docker tag team6-${service}:latest ${REGISTRY}/team6-${service}:${IMAGE_TAG}
            docker tag team6-${service}:latest ${REGISTRY}/team6-${service}:latest
          done

      - name: Push images
        run: |
          export IMAGE_TAG=${{ steps.settag.outputs.image_tag }}
          export REGISTRY=ghcr.io/${{ steps.setowner.outputs.owner_lc }}
          
          echo "ðŸ“¤ Pushing images..."
          for service in main-service study-service ml-service migrator; do
            docker push ${REGISTRY}/team6-${service}:${IMAGE_TAG}
            docker push ${REGISTRY}/team6-${service}:latest
          done

      - name: Create Summary with Progress Indicators
        if: success()
        run: |
          echo "## ðŸ“Š Build Progress" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "```mermaid" >> $GITHUB_STEP_SUMMARY
          echo "gantt" >> $GITHUB_STEP_SUMMARY
          echo "    title Build Timeline" >> $GITHUB_STEP_SUMMARY
          echo "    dateFormat  HH:mm:ss" >> $GITHUB_STEP_SUMMARY
          echo "    axisFormat  %H:%M" >> $GITHUB_STEP_SUMMARY
          echo "    section Services" >> $GITHUB_STEP_SUMMARY
          echo "    main-service   :done,  des1, 00:00:00, 2m" >> $GITHUB_STEP_SUMMARY
          echo "    study-service  :done,  des2, after des1, 2m" >> $GITHUB_STEP_SUMMARY
          echo "    ml-service     :done,  des3, after des2, 2m" >> $GITHUB_STEP_SUMMARY
          echo "    migrator       :done,  des4, after des3, 1m" >> $GITHUB_STEP_SUMMARY
          echo "    section Push" >> $GITHUB_STEP_SUMMARY
          echo "    Push to GHCR   :done,  push, after des4, 3m" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## âœ… Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SERVICES=("main-service" "study-service" "ml-service" "migrator")
          EMOJIS=("ðŸ " "ðŸ“š" "ðŸ¤–" "ðŸ—ƒï¸")

          for i in "${!SERVICES[@]}"; do
            SERVICE="${SERVICES[$i]}"
            EMOJI="${EMOJIS[$i]}"

            echo "### ${EMOJI} ${SERVICE}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** \`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-${SERVICE}:${{ steps.settag.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Latest:** \`ghcr.io/${{ steps.setowner.outputs.owner_lc }}/team6-${SERVICE}:latest\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          echo "## ðŸ“ˆ Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total services built:** 4" >> $GITHUB_STEP_SUMMARY
          echo "- **Total images pushed:** 8 (4 services Ã— 2 tags each)" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** \`ghcr.io/${{ steps.setowner.outputs.owner_lc }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "ðŸŽ‰ **All images are now available in GitHub Container Registry!**" >> $GITHUB_STEP_SUMMARY